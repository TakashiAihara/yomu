name: Deploy to K3s

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    # „Çª„Ç≠„É•„É™„ÉÜ„Ç£: main„Éñ„É©„É≥„ÉÅ„ÅÆ„Åø
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: production
      # Manual approval required for production migrations
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify K3s connection
        run: |
          kubectl get nodes
          kubectl version --short

      - name: Create namespace
        run: |
          kubectl apply -f k8s/namespace.yaml

      - name: Apply ConfigMap
        run: |
          kubectl apply -f k8s/yomu/configmap.yaml

      - name: Run Database Migration
        id: migration
        run: |
          # Generate unique Job name with timestamp
          TIMESTAMP=$(date +%s)
          JOB_NAME="yomu-migration-${TIMESTAMP}"
          echo "job_name=${JOB_NAME}" >> $GITHUB_OUTPUT
          
          echo "Creating migration Job: ${JOB_NAME}"
          
          # Create Job from template with unique name
          kubectl create -f k8s/yomu/migration-job.yaml \
            --dry-run=client -o yaml | \
            sed "s/name: yomu-migration/name: ${JOB_NAME}/" | \
            kubectl apply -f -
          
          # Wait for Job completion (timeout 5 minutes)
          echo "Waiting for migration to complete..."
          if kubectl wait --for=condition=complete \
            --timeout=300s job/${JOB_NAME} -n yomu; then
            echo "‚úÖ Migration completed successfully"
          else
            echo "‚ùå Migration failed or timed out"
            kubectl logs job/${JOB_NAME} -n yomu || true
            exit 1
          fi
          
          # Show migration logs
          echo "Migration logs:"
          kubectl logs job/${JOB_NAME} -n yomu

      - name: Deploy Yomu API
        id: deploy
        run: |
          # Store current deployment revision for potential rollback
          CURRENT_REVISION=$(kubectl rollout history deployment/yomu-api -n yomu --revision=0 | tail -n 1 | awk '{print $1}') || echo "0"
          echo "current_revision=${CURRENT_REVISION}" >> $GITHUB_OUTPUT
          
          kubectl apply -f k8s/yomu/deployment.yaml
          kubectl apply -f k8s/yomu/service.yaml

      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/yomu-api -n yomu --timeout=5m

      - name: Show deployment status
        run: |
          echo "=== Pods ==="
          kubectl get pods -n yomu
          echo ""
          echo "=== Services ==="
          kubectl get svc -n yomu
          echo ""
          echo "=== Deployment ==="
          kubectl get deployment -n yomu

      - name: Rollback on failure
        if: failure() && steps.migration.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è  Migration failed - initiating rollback"
          
          # Get previous revision
          PREV_REVISION="${{ steps.deploy.outputs.current_revision }}"
          
          if [ "${PREV_REVISION}" != "0" ] && [ -n "${PREV_REVISION}" ]; then
            echo "Rolling back to revision ${PREV_REVISION}"
            kubectl rollout undo deployment/yomu-api -n yomu --to-revision=${PREV_REVISION}
            kubectl rollout status deployment/yomu-api -n yomu --timeout=3m
            echo "‚úÖ Rollback completed"
          else
            echo "‚ö†Ô∏è  No previous revision found - cannot rollback"
          fi
          
          # Alert (this would integrate with your alerting system)
          echo "üö® ALERT: Migration failed in production - deployment blocked and rolled back"
          echo "Migration Job: ${{ steps.migration.outputs.job_name }}"
          echo "Check logs: kubectl logs job/${{ steps.migration.outputs.job_name }} -n yomu"
